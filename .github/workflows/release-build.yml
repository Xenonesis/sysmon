name: Build and Release on Push

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
  workflow_dispatch:
    inputs:
      version:
        description: 'Tag / version to publish (e.g. v1.0.0)'
        required: false
        default: ''
      release_name:
        description: 'Release title'
        required: false
        default: 'System Monitor Release'
      draft:
        description: 'Make release a draft?'
        required: false
        default: false
      prerelease:
        description: 'Mark release as prerelease?'
        required: false
        default: false

jobs:
  build-windows-release:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: ~/.cargo/registry
          key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}

      - name: Build release
        run: |
          cargo build --release

      - name: Get version from Cargo.toml
        id: get_version
        run: |
          $cargoToml = Get-Content "Cargo.toml" -Raw
          if ($cargoToml -match 'version\s*=\s*"([^"]+)"') {
              $version = $matches[1]
              Write-Host "Version from Cargo.toml: $version"
              echo "version=v$version" >> $env:GITHUB_OUTPUT
              echo "version_number=$version" >> $env:GITHUB_OUTPUT
          } else {
              Write-Error "Could not extract version from Cargo.toml"
              exit 1
          }

      - name: Prepare build artifacts
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $exeName = "SystemMonitor-$version.exe"
          $zipName = "SystemMonitor-$version.zip"
          $latestExe = "SystemMonitor-latest.exe"
          
          Write-Host "Creating build artifacts for version: $version"
          
          if (Test-Path "target\release\system-monitor.exe") {
              # Create versioned .exe
              Copy-Item "target\release\system-monitor.exe" $exeName -Force
              Write-Host "Created: $exeName"
              
              # Create latest .exe
              Copy-Item "target\release\system-monitor.exe" $latestExe -Force
              Write-Host "Created: $latestExe"
              
              # Create ZIP with installer
              Compress-Archive -Path target\release\system-monitor.exe, setup.bat, installer.ps1, README.md -DestinationPath $zipName -Force
              Write-Host "Created: $zipName"
              
              # Copy to docs/downloads/ for GitHub Pages
              Write-Host "Copying to docs/downloads/ for GitHub Pages..."
              if (-not (Test-Path "docs\downloads")) {
                  New-Item -ItemType Directory -Path "docs\downloads" -Force | Out-Null
              }
              Copy-Item $exeName "docs\downloads\$exeName" -Force
              Copy-Item $latestExe "docs\downloads\$latestExe" -Force
              Copy-Item $zipName "docs\downloads\$zipName" -Force
              Write-Host "âœ“ Files copied to docs/downloads/"
              
          } else {
              Write-Error "Executable not found: target\release\system-monitor.exe"
              exit 1
          }

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: SystemMonitor-${{ steps.get_version.outputs.version }}
          path: |
            SystemMonitor-*.exe
            SystemMonitor-*.zip

      - name: Check if release exists
        id: check_release
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $repo = "${{ github.repository }}"
          $token = "${{ secrets.GITHUB_TOKEN }}"
          
          try {
              $headers = @{
                  Authorization = "Bearer $token"
                  Accept = "application/vnd.github.v3+json"
              }
              $response = Invoke-RestMethod -Uri "https://api.github.com/repos/$repo/releases/tags/$version" -Headers $headers -ErrorAction Stop
              echo "exists=true" >> $env:GITHUB_OUTPUT
              echo "release_id=$($response.id)" >> $env:GITHUB_OUTPUT
              Write-Host "Release $version already exists with ID: $($response.id)"
          } catch {
              echo "exists=false" >> $env:GITHUB_OUTPUT
              Write-Host "Release $version does not exist yet"
          }

      - name: Create or Update GitHub Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: System Monitor ${{ steps.get_version.outputs.version }}
          body: |
            ## System Monitor ${{ steps.get_version.outputs.version_number }}
            
            ### ðŸš€ What's New
            - Auto-built from commit ${{ github.sha }}
            - Direct .exe download available
            - No installation required - just run!
            
            ### ðŸ“¥ Download
            - **SystemMonitor-${{ steps.get_version.outputs.version }}.exe** - Direct application (recommended)
            - **SystemMonitor-latest.exe** - Always points to latest version
            - **SystemMonitor-${{ steps.get_version.outputs.version }}.zip** - Package with installer scripts
            
            ### ðŸŽ¯ Quick Start
            1. Download `SystemMonitor-${{ steps.get_version.outputs.version }}.exe`
            2. Run the .exe file
            3. Enjoy real-time system monitoring!
            
            ### ðŸ”„ Auto-Update
            The application includes built-in auto-update functionality that checks for new versions every 24 hours.
          files: |
            SystemMonitor-${{ steps.get_version.outputs.version }}.exe
            SystemMonitor-latest.exe
            SystemMonitor-${{ steps.get_version.outputs.version }}.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and push to docs/downloads/
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/downloads/*.exe docs/downloads/*.zip
          git diff --staged --quiet || git commit -m "ðŸš€ Auto-deploy: Update binaries to ${{ steps.get_version.outputs.version }}"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Output release information
        run: |
          $version = "${{ steps.get_version.outputs.version }}"
          $repo = "${{ github.repository }}"
          Write-Host "âœ… Release created successfully!"
          Write-Host ""
          Write-Host "ðŸ“¦ Release: $version"
          Write-Host "ðŸ”— URL: https://github.com/$repo/releases/tag/$version"
          Write-Host ""
          Write-Host "ðŸ“¥ GitHub Pages Download links:"
          Write-Host "  â€¢ SystemMonitor-$version.exe"
          Write-Host "    https://USERNAME.github.io/REPO/downloads/SystemMonitor-$version.exe"
          Write-Host ""
          Write-Host "  â€¢ SystemMonitor-latest.exe"
          Write-Host "    https://USERNAME.github.io/REPO/downloads/SystemMonitor-latest.exe"
          Write-Host ""
          Write-Host "ðŸ“¥ GitHub Releases Download links:"
          Write-Host "  â€¢ SystemMonitor-$version.exe"
          Write-Host "    https://github.com/$repo/releases/download/$version/SystemMonitor-$version.exe"
          Write-Host ""
          Write-Host "  â€¢ SystemMonitor-latest.exe"
          Write-Host "    https://github.com/$repo/releases/download/$version/SystemMonitor-latest.exe"
          Write-Host ""
          Write-Host "  â€¢ SystemMonitor-$version.zip"
          Write-Host "    https://github.com/$repo/releases/download/$version/SystemMonitor-$version.zip"
